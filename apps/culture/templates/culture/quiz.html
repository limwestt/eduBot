{% extends 'base.html' %}
{% block title %}Quiz — {{ fait.titre }} — EduBot{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto px-4 py-10">
  <div class="animate-slide-up">

    <a href="{% url 'culture_fait' fait.id %}" class="inline-flex items-center gap-2 text-sm text-gray-500 hover:text-violet-600 mb-8 transition-colors font-medium">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
      Retour au fait
    </a>

    <!-- Header quiz -->
    <div class="card mb-6" style="padding:20px;background:linear-gradient(135deg,rgba(124,58,237,0.06),rgba(109,40,217,0.02));border-color:rgba(124,58,237,0.18)">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-violet-500 to-purple-700 flex items-center justify-center shadow-md">
          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        </div>
        <div>
          <h1 class="text-lg font-extrabold text-gray-900">{{ fait.titre }}</h1>
          <p class="text-sm text-gray-500">3 questions — 10 points par bonne réponse</p>
        </div>
      </div>

      <!-- Barre progression -->
      <div class="mt-4">
        <div class="flex justify-between text-xs text-gray-400 mb-1">
          <span>Progression</span>
          <span id="progressLabel">0 / 3</span>
        </div>
        <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
          <div id="progressBar" class="h-full rounded-full bg-gradient-to-r from-violet-500 to-purple-600 transition-all duration-300" style="width:0%"></div>
        </div>
      </div>
    </div>

    <!-- Questions -->
    <form method="post" id="quizForm">
      {% csrf_token %}
      <div class="space-y-6">
        {% for question in questions %}
        <div class="card question-card" id="qcard-{{ forloop.counter }}" style="{% if not forloop.first %}opacity:0.4;pointer-events:none{% endif %}">
          <div class="flex items-center gap-3 mb-5">
            <div class="w-8 h-8 rounded-lg bg-violet-100 flex items-center justify-center flex-shrink-0">
              <span class="text-violet-700 font-black text-sm">{{ forloop.counter }}</span>
            </div>
            <p class="font-semibold text-gray-900 text-sm leading-snug">{{ question.texte }}</p>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            {% for choix, label in question.choix_a|add:"§A",question.choix_b|add:"§B",question.choix_c|add:"§C",question.choix_d|add:"§D" %}
            {% endfor %}

            <!-- Choix A -->
            <label class="choix-label flex items-center gap-3 p-4 rounded-xl border-2 border-gray-100 hover:border-violet-300 hover:bg-violet-50 cursor-pointer transition-all group">
              <input type="radio" name="question_{{ question.id }}" value="A"
                class="choix-radio w-4 h-4 text-violet-600 hidden" required
                onchange="selectChoix(this)">
              <div class="w-7 h-7 rounded-lg bg-gray-100 group-hover:bg-violet-100 flex items-center justify-center flex-shrink-0 transition-colors choix-badge">
                <span class="text-xs font-bold text-gray-500 group-hover:text-violet-600 transition-colors">A</span>
              </div>
              <span class="text-sm text-gray-700 font-medium">{{ question.choix_a }}</span>
            </label>

            <!-- Choix B -->
            <label class="choix-label flex items-center gap-3 p-4 rounded-xl border-2 border-gray-100 hover:border-violet-300 hover:bg-violet-50 cursor-pointer transition-all group">
              <input type="radio" name="question_{{ question.id }}" value="B"
                class="choix-radio w-4 h-4 text-violet-600 hidden" required
                onchange="selectChoix(this)">
              <div class="w-7 h-7 rounded-lg bg-gray-100 group-hover:bg-violet-100 flex items-center justify-center flex-shrink-0 transition-colors choix-badge">
                <span class="text-xs font-bold text-gray-500 group-hover:text-violet-600 transition-colors">B</span>
              </div>
              <span class="text-sm text-gray-700 font-medium">{{ question.choix_b }}</span>
            </label>

            <!-- Choix C -->
            <label class="choix-label flex items-center gap-3 p-4 rounded-xl border-2 border-gray-100 hover:border-violet-300 hover:bg-violet-50 cursor-pointer transition-all group">
              <input type="radio" name="question_{{ question.id }}" value="C"
                class="choix-radio w-4 h-4 text-violet-600 hidden" required
                onchange="selectChoix(this)">
              <div class="w-7 h-7 rounded-lg bg-gray-100 group-hover:bg-violet-100 flex items-center justify-center flex-shrink-0 transition-colors choix-badge">
                <span class="text-xs font-bold text-gray-500 group-hover:text-violet-600 transition-colors">C</span>
              </div>
              <span class="text-sm text-gray-700 font-medium">{{ question.choix_c }}</span>
            </label>

            <!-- Choix D -->
            <label class="choix-label flex items-center gap-3 p-4 rounded-xl border-2 border-gray-100 hover:border-violet-300 hover:bg-violet-50 cursor-pointer transition-all group">
              <input type="radio" name="question_{{ question.id }}" value="D"
                class="choix-radio w-4 h-4 text-violet-600 hidden" required
                onchange="selectChoix(this)">
              <div class="w-7 h-7 rounded-lg bg-gray-100 group-hover:bg-violet-100 flex items-center justify-center flex-shrink-0 transition-colors choix-badge">
                <span class="text-xs font-bold text-gray-500 group-hover:text-violet-600 transition-colors">D</span>
              </div>
              <span class="text-sm text-gray-700 font-medium">{{ question.choix_d }}</span>
            </label>
          </div>
        </div>
        {% endfor %}
      </div>

      <button type="submit" id="submitBtn"
        class="btn-primary w-full justify-center py-4 text-sm mt-8 hidden">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
        Valider mes réponses
      </button>
    </form>

  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const totalQuestions = 3;
let answered = 0;

function selectChoix(radio) {
  const card = radio.closest('.question-card');

  // Style visuel de la sélection
  card.querySelectorAll('.choix-label').forEach(label => {
    label.classList.remove('border-violet-500', 'bg-violet-50');
    label.classList.add('border-gray-100');
  });
  const selected = radio.closest('.choix-label');
  selected.classList.remove('border-gray-100');
  selected.classList.add('border-violet-500', 'bg-violet-50');

  // Activer la question suivante
  const cards = document.querySelectorAll('.question-card');
  const currentIndex = Array.from(cards).indexOf(card);

  if (currentIndex + 1 < cards.length) {
    setTimeout(() => {
      const nextCard = cards[currentIndex + 1];
      nextCard.style.opacity = '1';
      nextCard.style.pointerEvents = 'auto';
      nextCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 300);
  }

  // Compteur progression
  const answered = document.querySelectorAll('.choix-radio:checked').length;
  const pct = (answered / totalQuestions) * 100;
  document.getElementById('progressBar').style.width = pct + '%';
  document.getElementById('progressLabel').textContent = answered + ' / ' + totalQuestions;

  // Afficher bouton submit si toutes répondues
  if (answered === totalQuestions) {
    document.getElementById('submitBtn').classList.remove('hidden');
    document.getElementById('submitBtn').scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}
</script>
{% endblock %}
