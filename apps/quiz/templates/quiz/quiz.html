{% extends 'base.html' %}
{% block title %}Quiz {{ config.label }} — EduBot{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto px-4 py-10">
  <div class="animate-slide-up">

    <!-- Header -->
    <div class="card mb-6" style="padding:20px;background:linear-gradient(135deg,rgba(124,58,237,0.06),rgba(109,40,217,0.02));border-color:rgba(124,58,237,0.18)">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-violet-500 to-purple-700 flex items-center justify-center shadow-md">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          </div>
          <div>
            <h1 class="text-lg font-extrabold text-gray-900">Quiz {{ config.label }}</h1>
            <p class="text-xs text-gray-500">Généré par IA — {{ total }} questions uniques</p>
          </div>
        </div>
        <div class="flex items-center gap-2 px-3 py-2 rounded-xl bg-violet-50 border border-violet-200">
          <svg class="w-4 h-4 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          <span id="timer" class="text-violet-700 font-bold text-sm">00:00</span>
        </div>
      </div>
      <div>
        <div class="flex justify-between text-xs text-gray-400 mb-1">
          <span>Progression</span>
          <span id="progressLabel">0 / {{ total }}</span>
        </div>
        <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
          <div id="progressBar" class="h-full rounded-full bg-gradient-to-r from-violet-500 to-purple-600 transition-all duration-300" style="width:0%"></div>
        </div>
      </div>
    </div>

    <!-- Formulaire -->
    <form method="post" id="quizForm">
      {% csrf_token %}
      <input type="hidden" name="temps_employe" id="tempsInput" value="0">

      <div class="space-y-6" id="questionsContainer">
        {% for question in questions %}
        <div class="card question-card" 
             id="qcard-{{ forloop.counter0 }}"
             data-index="{{ forloop.counter0 }}"
             style="{% if not forloop.first %}opacity:0.4;pointer-events:none;{% endif %}">

          <div class="flex items-start gap-3 mb-5">
            <div class="w-8 h-8 rounded-lg bg-violet-100 flex items-center justify-center flex-shrink-0">
              <span class="text-violet-700 font-black text-sm">{{ forloop.counter }}</span>
            </div>
            <p class="font-semibold text-gray-900 text-sm leading-snug pt-1">{{ question.texte }}</p>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">

            <div class="choix-item flex items-center gap-3 p-4 rounded-xl border-2 border-gray-100 hover:border-violet-300 hover:bg-violet-50 cursor-pointer transition-all"
                 data-card="{{ forloop.counter0 }}" data-value="A">
              <input type="radio" name="question_{{ forloop.counter0 }}" value="A" class="hidden">
              <div class="w-7 h-7 rounded-lg bg-gray-100 flex items-center justify-center flex-shrink-0">
                <span class="text-xs font-bold text-gray-500">A</span>
              </div>
              <span class="text-sm text-gray-700 font-medium">{{ question.choix_a }}</span>
            </div>

            <div class="choix-item flex items-center gap-3 p-4 rounded-xl border-2 border-gray-100 hover:border-violet-300 hover:bg-violet-50 cursor-pointer transition-all"
                 data-card="{{ forloop.counter0 }}" data-value="B">
              <input type="radio" name="question_{{ forloop.counter0 }}" value="B" class="hidden">
              <div class="w-7 h-7 rounded-lg bg-gray-100 flex items-center justify-center flex-shrink-0">
                <span class="text-xs font-bold text-gray-500">B</span>
              </div>
              <span class="text-sm text-gray-700 font-medium">{{ question.choix_b }}</span>
            </div>

            <div class="choix-item flex items-center gap-3 p-4 rounded-xl border-2 border-gray-100 hover:border-violet-300 hover:bg-violet-50 cursor-pointer transition-all"
                 data-card="{{ forloop.counter0 }}" data-value="C">
              <input type="radio" name="question_{{ forloop.counter0 }}" value="C" class="hidden">
              <div class="w-7 h-7 rounded-lg bg-gray-100 flex items-center justify-center flex-shrink-0">
                <span class="text-xs font-bold text-gray-500">C</span>
              </div>
              <span class="text-sm text-gray-700 font-medium">{{ question.choix_c }}</span>
            </div>

            <div class="choix-item flex items-center gap-3 p-4 rounded-xl border-2 border-gray-100 hover:border-violet-300 hover:bg-violet-50 cursor-pointer transition-all"
                 data-card="{{ forloop.counter0 }}" data-value="D">
              <input type="radio" name="question_{{ forloop.counter0 }}" value="D" class="hidden">
              <div class="w-7 h-7 rounded-lg bg-gray-100 flex items-center justify-center flex-shrink-0">
                <span class="text-xs font-bold text-gray-500">D</span>
              </div>
              <span class="text-sm text-gray-700 font-medium">{{ question.choix_d }}</span>
            </div>

          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Bouton submit — TOUJOURS dans le DOM, juste caché -->
      <div id="submitWrapper" style="display:none;margin-top:32px;">
        <button type="submit" class="btn-primary w-full justify-center py-4 text-sm">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
          Valider mes réponses
        </button>
      </div>

    </form>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const TOTAL = {{ total }};
const reponses = {};
let secondes = 0;

// Timer
const timerInterval = setInterval(() => {
  secondes++;
  const m = String(Math.floor(secondes / 60)).padStart(2, '0');
  const s = String(secondes % 60).padStart(2, '0');
  document.getElementById('timer').textContent = m + ':' + s;
  document.getElementById('tempsInput').value = secondes;
}, 1000);

// Clic sur un choix
document.querySelectorAll('.choix-item').forEach(item => {
  item.addEventListener('click', function() {
    const cardIndex = this.dataset.card;
    const value = this.dataset.value;
    const card = document.getElementById('qcard-' + cardIndex);

    // Coche le radio
    const radio = this.querySelector('input[type=radio]');
    radio.checked = true;

    // Enregistre la réponse
    reponses[cardIndex] = value;

    // Reset styles de la carte
    card.querySelectorAll('.choix-item').forEach(c => {
      c.classList.remove('border-violet-500', 'bg-violet-50');
      c.classList.add('border-gray-100');
    });
    // Surligne le choix
    this.classList.remove('border-gray-100');
    this.classList.add('border-violet-500', 'bg-violet-50');

    // Mise à jour progression
    const nb = Object.keys(reponses).length;
    document.getElementById('progressBar').style.width = (nb / TOTAL * 100) + '%';
    document.getElementById('progressLabel').textContent = nb + ' / ' + TOTAL;

    // Déverrouille la prochaine carte
    const nextIndex = parseInt(cardIndex) + 1;
    if (nextIndex < TOTAL) {
      setTimeout(() => {
        const next = document.getElementById('qcard-' + nextIndex);
        next.style.opacity = '1';
        next.style.pointerEvents = 'auto';
        next.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 350);
    }

    // Affiche le bouton si tout répondu
    if (nb >= TOTAL) {
      clearInterval(timerInterval);
      const wrapper = document.getElementById('submitWrapper');
      wrapper.style.display = 'block';
      setTimeout(() => wrapper.scrollIntoView({ behavior: 'smooth', block: 'center' }), 400);
    }
  });
});
</script>
{% endblock %}
